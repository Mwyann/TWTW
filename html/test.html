<!DOCTYPE html>
<html>
<head>
<title>Comment Ã§a marche</title>
<meta charset="UTF-8" />
<style type="text/css">

body {
    background-color: #ECE3D1;
}

#onscreen {
    margin: 20px auto 5px auto;
    width: 638px;
    height: 458px;
}

</style>
<script src="jquery.min.js"></script>
<script type="text/javascript">

// 'fireOne' argument is optional, if set, will invoke the callback once for every
// image in the 'this' collection, thus making 'this' in the callback that element alone
// If it's not used, the callback will be invoked once all the images in the collection has
// been loaded. And 'this' will be the jQuery collection of the filtered 'img' elements.

jQuery.fn.imagesLoaded = function(callback, fireOne) {
  var
    args = arguments,
    elems = this.filter('img'),
    elemsLen = elems.length - 1;

  elems
    .bind('load', function(e) {
        //TODO Ajouter un bargraph ici
        if (fireOne) {
            !elemsLen-- && callback.call(elems, e);
        } else {
            callback.call(this, e);
        }
    }).each(function() {
        // cached images don't fire load sometimes, so we reset src.
        if (this.complete || this.complete === undefined){
            this.src = this.src;
        }
    });
}

var currentPage = -1;
var pages = new Array();
var currentLinks = new Array();

function preloadRes(idPage) {
  // Initialisation du preload
  var preload = jQuery('#preload');
  var audiores = jQuery('#audiores');
  var page = pages[idPage];
  if (currentPage == idPage) preload.html(''); // On va charger les infos des frames donc on vide pour initialiser la zone de chargement.
  if (currentPage == idPage) audiores.html('');

  // Chargement des frames
  var frames = page.frames;
  for(var i=0; i < frames.length; i++)
    preloadRes(frames[i]);

  // Chargement des liens
  var links = page.links;
  var link;
  for(var i=0; i < links.length; i++) {
    link = links[i];
    if ("src" in link) preload.append('<img />').children().last().attr('src',link.src);
    if ("audio" in link) {
      var t = audiores.append('<audio />').children().last().attr('id','audio'+idPage+'l'+i);
      t.append('<source />').children().last().attr('type','audio/ogg').attr('src',link.audio+'.ogg');
      t.append('<source />').children().last().attr('type','audio/mpeg').attr('src',link.audio+'.mp3');
    }
  }

  // Si on est dans le chargement de la page en question (pas une frame), on demande l'affichage de la page dès les images chargées
  if (currentPage == idPage) {
    jQuery('#preload img').imagesLoaded(function (e) {
      displayPage(idPage);
    }, true);
  }
}

var runningAnimID = 0;
var runningAnimTimeoutID = 0;
var nextPage = -1;
var nbFramesLeft = 0; // Utilisé pour détecter la fin d'une animation
var windowFocus = true;

function countingFrames() {
    //if (windowFocus) nbFramesLeft--;
    if (nbFramesLeft > 0) {
        runningAnimID = window.setTimeout(countingFrames,300);
    } else stopAnim();
}

function stopAnim() {
  if (runningAnimTimeoutID) {
    window.clearTimeout(runningAnimTimeoutID);runningAnimTimeoutID = 0;nbFramesLeft = 0;
    jQuery('#foreground').css("cursor", "pointer").html('<img src="transparent.gif" style="width:0;height:0" />');
    jQuery('#mask').css("cursor", "pointer").click(function(){}).html('<img src="transparent.gif" style="width:0;height:0" />').css({width:'0',height:'0'});
    var audiofile = jQuery('#'+currentLinks[runningAnimID].audioid).get(0);
    audiofile.pause();
    runningAnimID = 0;
    if (nextPage > -1) loadPage(nextPage);
  }
}

function runAnim(anim) {
  if (runningAnimTimeoutID) return stopAnim();
  jQuery('#mask').css("cursor", "wait").click(function(){stopAnim()}).html('<img src="transparent.gif" style="width:638px;height:458px" />').css({width:'638px',height:'458px'});
  jQuery('#foreground').html('<img />').children().attr('src',anim.src).css({position:'relative', left:anim.left.toString()+'px', top:anim.top.toString()+'px'});
  nbFramesLeft = 0;
  if ("nextpage" in anim) nextPage = anim.nextpage;
  runningAnimID = anim.id;
  runningAnimTimeoutID = window.setTimeout(countingFrames,anim.time);
  var audiofile = jQuery('#'+anim.audioid).get(0);
  audiofile.currentTime = 0;
  audiofile.play();
}

function runLink(idLink) {
  var link = currentLinks[idLink];
  link.id = idLink;
  if (link.type == 2) {  // Animation avec barre de défilement
    runAnim(link);
  }
  if (link.type == 3) {  // Objets cliquables avec différentes actions
    
  }
  if (link.type == 4) {  // Lettres de la roue alphabétique
    
  }
  if (link.type == 6) {  // Bouton de la colonne de gauche
    runAnim(link);
  }
  if (link.type == 7) {  // Animation simple
    runAnim(link);
  }
  if (link.type == 8) {  // Bouton d'annulation, utilisé dans la page d'options
    
  }
  if (link.type == 9) {  // Longue image scrollable utilisée dans l'aide
    
  }
}

function loadPage(pageId) {
  nextPage = -1;
  if (!(pageId in pages)) {
    alert('Page '+(pageId.toString())+' indisponible.');
  } else {
    // On précharge les données qui seront affichées lors de la fin du chargement
    currentPage = pageId;
    preloadRes(pageId);
  }
}

function displayPage(idPage) {
  // Initialisation
  var onscreen = jQuery('#onscreen');
  var page = pages[idPage];
  if (currentPage == idPage) {
    onscreen.html(''); // On va charger les infos des frames donc on vide pour initialiser la zone d'affichage de la page.
    currentLinks = new Array();
  }

  // Affichage des frames
  var frames = page.frames;
  for(var i=0; i < frames.length; i++)
    displayPage(frames[i]);

  // On ajoute les liens
  var links = page.links;
  var link;
  var autolink = -1;
  for(var i=0; i < links.length; i++) {
    link = links[i];
    if ("audio" in link) link.audioid = 'audio'+idPage+'l'+i;
    if (link.type == 1) {  // Image de fond
      onscreen.append('<img />').children().last().attr('src',link.src)
        .css({position:'absolute', left:link.left.toString()+'px', top:link.top.toString()+'px'});
    } else {
      onscreen.append('<div style="position:absolute;left:'+(link.x1.toString())+'px;top:'+(link.y1.toString())+'px;width:'+((link.x2-link.x1).toString())+'px;height:'+((link.y2-link.y1).toString())+'px;cursor:pointer" id="link'+(currentLinks.length.toString())+'" onclick="runLink('+(currentLinks.length.toString())+')"><img src="transparent.gif" style="width:'+((link.x2-link.x1).toString())+'px;height:'+((link.y2-link.y1).toString())+'px" /></div>');
      if (("autostart" in link) && (link.autostart)) autolink = currentLinks.length;
      currentLinks.push(link);
      // Précharger ici les images de fond des pages suivantes ?
    }
  }

  if (currentPage == idPage) {
    // On ajoute un div "foreground" pour les animations, et un "mask" pour masquer lors de la lecture des animations
    onscreen.append('<div style="position:absolute;left:0;top:0;width:0;height:0" id="foreground"><img src="transparent.gif" style="width:0;height:0" /></div>');
    onscreen.append('<div style="position:absolute;left:0;top:0;width:0;height:0" id="mask"><img src="transparent.gif" style="width:0;height:0" /></div>');
  }
  if (autolink > -1) runLink(autolink);
}

jQuery(document).ready(function() {
    loadPage(978);
});

/*
jQuery(document).focus(function() {
    windowFocus = true;
    if (runningAnimID) {
        jQuery('#audiores').children().last().get(0).play();
    }
}).blur(function() {
    windowFocus = false;
    if (runningAnimID) {
        jQuery('#audiores').children().last().get(0).pause();
    }
});
*/

</script>
<script src="js/total.min.js" type="text/javascript"></script>
</head>
<body>

<div style="position:relative" id="onscreen"><div style="text-align:center;font-size:smaller">Chargement...</div></div>
<div style="text-align:center;font-size:smaller">(c) 1994 Dorling Kindersley, Larousse, David Macaulay et Neil Ardley</div>

<div style="display:none" id="preload"></div>
<div style="display:none" id="audiores"></div>

</body>
</html>